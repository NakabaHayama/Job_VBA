<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ともっこ広場 申込み</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 2rem; }
  figure { display:inline-block; margin:0 1rem 1rem 0; text-align:center; }
  img { max-width: 220px; height: auto; display:block; }
  form { margin: 1.5rem 0; padding: 1rem; border: 1px solid #ccc; border-radius: 12px; max-width: 520px; }
  form label { display:block; margin: 0.6rem 0 0.25rem; font-weight: 600; }
  form input, form select { width: 100%; padding: 0.5rem; border:1px solid #bbb; border-radius: 8px; }
  form button { margin-top: 0.8rem; padding: 0.7rem 1.2rem; border-radius: 10px; border: none; background:#0a84ff; color:#fff; font-weight:700; cursor:pointer; }
  .note { color:#555; font-size: 0.9rem; }
  .ok { color: #0a8a3a; }
  .ng { color: #b00020; }
</style>
<body>
  <h1>鞆こども園 子育て支援「ともっこ広場」申込み</h1>
  <p><a href="./index.html">← トップへ戻る</a></p>

  <!-- ① 表題（現在の月を自動表示） -->
  <h2>ともっこ広場 <span id="month">〇</span> 月 申込み</h2>

  <!-- ② 申込みフォーム（4項目） -->
  <form id="applyForm">
    <label for="name">申込者氏名</label>
    <input type="text" id="name" name="name" autocomplete="name" required>

    <label for="event">行事名 <span class="note">（スプレッドシートから自動読込）</span></label>
    <select id="event" name="event" required>
      <option value="">読み込み中…</option>
    </select>

    <label for="kids">こどもの人数</label>
    <input type="number" id="kids" name="kids" inputmode="numeric" min="0" step="1" value="0" required>

    <label for="adults">大人の人数</label>
    <input type="number" id="adults" name="adults" inputmode="numeric" min="0" step="1" value="0" required>

    <button type="submit">送信する</button>
    <div id="msg" class="note" role="status" aria-live="polite"></div>
  </form>

  <h2>資料リンク</h2>
  <p><a href="./data/manual.pdf" target="_blank">manual.pdf を開く</a></p>

  <h2>鞆こども園ギャラリー（JSONから生成）</h2>
  <div id="gallery">Loading…</div>

  <script>
    // === 設定（後でURLを差し替え） ===
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwiL1RJlCrPzNkC0U6qKrj26MFfc6ntnJC3rADqnltASXUSDMh2acl_cdp0pJpDyhci/exec";  // Apps Script Web アプリのURL（下で作成）

    // 表題の月（現在月を自動セット）
    document.getElementById("month").textContent = new Date().getMonth() + 1;

    // 行事名リストを取得してプルダウンに反映
    async function loadEvents() {
      const sel = document.getElementById("event");
      try {
        const res = await fetch(WEBAPP_URL + "?mode=events");
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json(); // { events: ["...","..."] }
        sel.innerHTML = '<option value="">選択してください</option>';
        (data.events || []).forEach(ev => {
          const opt = document.createElement("option");
          opt.value = ev;
          opt.textContent = ev;
          sel.appendChild(opt);
        });
        if (!data.events?.length) {
          sel.innerHTML = '<option value="">（行事リスト未登録）</option>';
        }
      } catch (e) {
        sel.innerHTML = '<option value="">読込に失敗しました</option>';
        console.error(e);
      }
    }

    // 送信（4項目 → スプレッドシートに転記）
    document.getElementById("applyForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("msg");
      msg.textContent = "送信中…";

      const payload = {
        name:   document.getElementById("name").value.trim(),
        event:  document.getElementById("event").value.trim(),
        kids:   Number(document.getElementById("kids").value || 0),
        adults: Number(document.getElementById("adults").value || 0),
      };
      if (!payload.name || !payload.event) {
        msg.textContent = "氏名と行事名は必須です。";
        msg.className = "note ng";
        return;
      }

      try {
        const res = await fetch(WEBAPP_URL, {
          method: "POST",
          // headers: { "Content-Type": "application/json" },
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload),
        });
        const data = await res.json(); // { ok: true } など
        if (data.ok) {
          msg.textContent = "送信しました。ありがとうございました。";
          msg.className = "note ok";
          e.target.reset();
        } else {
          throw new Error(data.error || "不明なエラー");
        }
      } catch (err) {
        console.error(err);
        msg.textContent = "送信に失敗しました。時間をおいて再度お試しください。";
        msg.className = "note ng";
      }
    });

    // ギャラリー（既存のまま）
    async function main(){
      try {
        const res = await fetch('./data/items.json');
        const items = await res.json();
        const wrap = document.getElementById('gallery');
        wrap.textContent = '';
        for (const it of items) {
          const fig = document.createElement('figure');
          const img = document.createElement('img');
          img.src = it.src;
          img.alt = it.title || '';
          const cap = document.createElement('figcaption');
          cap.textContent = it.title || '';
          fig.append(img, cap);
          wrap.append(fig);
        }
      } catch (e) {
        document.getElementById('gallery').textContent = '読み込みに失敗しました。' + e;
      }
    }

    // 起動時
    loadEvents();
    main();
  </script>
</body>
</html>
