<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ともっこ広場 申込み</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 2rem; }
  figure { display:inline-block; margin:0 1rem 1rem 0; text-align:center; }
  img { max-width: 220px; height: auto; display:block; }
  form { margin: 1.5rem 0; padding: 1rem; border: 1px solid #ccc; border-radius: 12px; max-width: 520px; }
  form label { display:block; margin: 0.6rem 0 0.25rem; font-weight: 600; }
  form input, form select { width: 100%; padding: 0.5rem; border:1px solid #bbb; border-radius: 8px; }
  form button { margin-top: 0.8rem; padding: 0.7rem 1.2rem; border-radius: 10px; border: none; background:#0a84ff; color:#fff; font-weight:700; cursor:pointer; }
  .note { color:#555; font-size: 0.9rem; }
  .ok { color: #0a8a3a; }
  .ng { color: #b00020; }
</style>
<body>
  <h2>「ともっこひろば」申込み</h2>
  <h3>鞆こども園子育て支援事業</h3>
  
  <!-- ① 表題（現在の月を自動表示） -->
　 <h2><span id="month">〇</span> 月以降の申込み</h2> 

  <!-- ② 申込みフォーム（4項目） -->
    <!-- ② 申込みフォーム（6項目） -->
  <form id="applyForm">
    <label for="name">参加者（お子様の名前）</label>
    <input type="text" id="name" name="name" autocomplete="name" required>

    <label for="event">行事名 <span class="note">（スプレッドシートから自動読込）</span></label>
    <select id="event" name="event" required>
      <option value="">読み込み中…</option>
    </select>

    <label for="kids">こどもの人数</label>
    <input type="number" id="kids" name="kids" inputmode="numeric" min="0" step="1" value="0" required>

    <label for="adults">大人の人数</label>
    <input type="number" id="adults" name="adults" inputmode="numeric" min="0" step="1" value="0" required>

    <!-- 追加：電話番号 -->
    <label for="tel">電話番号</label>
    <input type="tel" id="tel" name="tel" autocomplete="tel" inputmode="tel"
           placeholder="070-1234-5678" required>

    <!-- 追加：メールアドレス -->
    <label for="email">メールアドレス（任意です）</label>
    <input type="email" id="email" name="email" autocomplete="email"
           placeholder="example@example.com">

    <button type="submit">送信する（メールへの確認通知はありません：登録内容はメモをお願いします）</button>
    <div id="msg" class="note" role="status" aria-live="polite"></div>
  </form>

<h4>「ともっこひろば」「笑いの広場」は、どなたでも参加できます。プレパパ・プレママ(プレ：ご出産前の)やパパの参加大歓迎！じいじ・ばあばもご一緒にどうぞ！たくさんのご参加お待ちしています。</h4>

  <h2>資料リンク</h2>
  <p><a href="./data/sc9.jpg" target="_blank"> スケジュールを開く</a></p>


  <!-- ★予約について★ -->
  <h2>★予約について★</h2>

  <ul>
    <li>前の月の20日以降(平日)からご予約ができます。</li>
    <li>ともっこひろばに来ていただいた時、またはお電話でもご予約できます。</li>
  </ul>

  <p>
    電話予約受付日時：平日（月曜日～金曜日）<br>
    13時～15時半
  </p>
  <p>
    子育て支援直通電話<br>
    ℡：070-4134-2502
  </p>


  <h2>ギャラリー</h2>
  <div id="gallery">Loading…</div>


  <p><a href="https://www.tomokids.net/%E5%AD%90%E8%82%B2%E3%81%A6%E6%94%AF%E6%8F%B4/">← 子育て支援HP</a></p>


  <script>
  // === 設定（後でURLを差し替え） ===
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxzbXT88R8jbr65fqbrf2jQMp27s2Ye7PLFl0_m2pu-AhG900HLAR3FrzmAzzAIUKjP/exec";

  // 表題の月（現在月を自動セット）
  document.getElementById("month").textContent = new Date().getMonth() + 1;

// 行事名リストを取得してプルダウンに反映（残数が0以下なら disabled にする）
async function loadEvents() {
  const sel = document.getElementById("event");
  try {
    const res = await fetch(WEBAPP_URL + "?mode=events");
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    const data = await res.json(); // { events: [{ name:"行事名", remain:数値 }, ...] }

    sel.innerHTML = '<option value="">選択してください</option>';

    (data.events || []).forEach(ev => {
      const opt = document.createElement("option");

      if (typeof ev === 'string') {
        // 後方互換（古い形式の場合）
        opt.value = ev;
        opt.textContent = ev;
      } else {
        const name = ev.name ?? '';
        const remain = (ev.remain ?? '') === '' ? '' : Number(ev.remain);

        opt.value = name; // 送信は行事名だけ

        if (remain === '' || Number.isNaN(remain)) {
          // 残数が空なら通常表示
          opt.textContent = name;
        } else if (remain <= 0) {
          // 満員 → disabled にして「現在満員・予約待ち」表示
          opt.textContent = `${name}（現在満員・キャンセル待）`;
          opt.disabled = true;
        } else {
          // 残数あり
          opt.textContent = `${name}（残り${remain}家族）`;
        }
      }

      sel.appendChild(opt);
    });

    if (!data.events?.length) {
      sel.innerHTML = '<option value="">（行事リスト未登録）</option>';
    }
  } catch (e) {
    sel.innerHTML = '<option value="">読込に失敗しました</option>';
    console.error(e);
  }
}

// // 行事名リストを取得してプルダウンに反映（value=行事名だけ、表示は「行事名（残りX家族）」）
// async function loadEvents() {
// const sel = document.getElementById("event");
// try {
// const res = await fetch(WEBAPP_URL + "?mode=events");
// if (!res.ok) throw new Error(res.status + " " + res.statusText);
// const data = await res.json(); // 推奨: { events: [{ name: "行事名", remain: 数値 }, ...] }


// sel.innerHTML = '<option value="">選択してください</option>';


// (data.events || []).forEach(ev => {
// const opt = document.createElement("option");


// // 後方互換: ev が文字列の場合は、そのまま表示して value=文字列
// if (typeof ev === 'string') {
// opt.value = ev; // 旧API互換（この場合は表示=送信値が同じになります）
// opt.textContent = ev;
// } else {
// // 新API: {name, remain}
// const name = ev.name ?? '';
// const remain = (ev.remain ?? '') === '' ? '' : String(ev.remain);
// opt.value = name; // 送信は行事名だけ
// opt.textContent = remain === '' ? name : `${name}（残り${remain}家族）`;
// }
// sel.appendChild(opt);
// });


// if (!data.events?.length) {
// sel.innerHTML = '<option value="">（行事リスト未登録）</option>';
// }
// } catch (e) {
// sel.innerHTML = '<option value="">読込に失敗しました</option>';
// console.error(e);
// }
// }

  // // 行事名リストを取得してプルダウンに反映
  // async function loadEvents() {
  //   const sel = document.getElementById("event");
  //   try {
  //     const res = await fetch(WEBAPP_URL + "?mode=events");
  //     if (!res.ok) throw new Error(res.status + " " + res.statusText);
  //     const data = await res.json(); // { events: ["...","..."] }
  //     sel.innerHTML = '<option value="">選択してください</option>';
  //     (data.events || []).forEach(ev => {
  //       const opt = document.createElement("option");
  //       opt.value = ev;
  //       opt.textContent = ev;
  //       sel.appendChild(opt);
  //     });
  //     if (!data.events?.length) {
  //       sel.innerHTML = '<option value="">（行事リスト未登録）</option>';
  //     }
  //   } catch (e) {
  //     sel.innerHTML = '<option value="">読込に失敗しました</option>';
  //     console.error(e);
  //   }
  // }

  // 送信（6項目 → スプレッドシートへ）
  document.getElementById("applyForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = document.getElementById("msg");
    msg.textContent = "送信中…";
    msg.className = "note";

    const payload = {
      name:   document.getElementById("name").value.trim(),
      event:  document.getElementById("event").value.trim(),
      kids:   Number(document.getElementById("kids").value || 0),
      adults: Number(document.getElementById("adults").value || 0),
      tel:    document.getElementById("tel").value.trim(),
      email:  document.getElementById("email").value.trim(),
    };

    if (!payload.name || !payload.event || !payload.tel) {
      msg.textContent = "氏名・行事名・電話番号は必須です。";
      msg.className = "note ng";
      return;
    }

    try {
      const res = await fetch(WEBAPP_URL, {
        method: "POST",
        // JSONだと一部環境でプリフライトが走るため、従来どおり text/plain を継続
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });
      const data = await res.json(); // { ok: true } など
      if (data.ok) {
        alert("送信しました。ありがとうございました。メールでのお客様への確認通知はありません。変更や再度の登録確認はお手数ですが、お電話か直接園でお問い合わせ下さい。");
        msg.textContent = "";
        msg.className = "note ok";
        e.target.reset();
      } else {
        throw new Error(data.error || "不明なエラー");
      }
    } catch (err) {
      console.error(err);
      msg.textContent = "送信に失敗しました。時間をおいて再度お試しください。";
      msg.className = "note ng";
    }
  });

  // ギャラリー（キャッシュ回避付きのまま）
  async function main(){
    try {
      const res = await fetch('./data/items.json?v=' + Date.now(), { cache: 'no-store' });
      const items = await res.json();

      const wrap = document.getElementById('gallery');
      wrap.textContent = '';
      for (const it of items) {
        const fig = document.createElement('figure');
        const img = document.createElement('img');
        img.src = it.src;
        img.alt = it.title || '';
        const cap = document.createElement('figcaption');
        cap.textContent = it.title || '';
        fig.append(img, cap);
        wrap.append(fig);
      }
    } catch (e) {
      document.getElementById('gallery').textContent = '読み込みに失敗しました。' + e;
    }
  }

  // 起動時
  loadEvents();
  main();
</script>




</body>
</html>


